---
title: Http&TCP连接
date: 2018-08-21 23:09:35
tags: Http
---

### HTTP协议与TCP/IP协议的关系

HTTP的长连接和短连接本质上是TCP长连接和短连接。HTTP属于应用层协议，在传输层使用TCP协议，在网络层使用IP协议。IP协议主要解决网络路由和寻址问题，TCP协议主要解决如何在IP层之上可靠的传递数据包，使在网络上的另一端收到发送端发出的所有包，并且顺序与发出顺序一致。TCP有可靠，面向连接的特点。

### 如何理解HTTP协议是无状态的

Http协议是无状态的，指的是协议对于事务处理是没有记忆能力的，服务器不知道客户端是什么状态的。

### 什么是持久连接？

- 在HTTP/1.0中，默认使用的是短连接。
- **但从 HTTP/1.1起，默认使用长连接，用以保持连接特性。**使用长连接的HTTP协议，会在响应头有加入这行代码：

HTTP1.0中有一个Connection首部字段，它是一个逐跳首部字段。Connection:Keep-Alive，表示希望将此条连接作为持久连接。

```
connection: keep-alive
```

在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的 TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接。Keep-Alive不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接要客户端和服务端都支持长连接。

HTTP1.1中，建立的HTTP请求默认是持久连接的。当Client确定不再需要向Server发送数据时，它可以关闭连接，即在发送首部中添加Connection:Closed字段。

HTTP协议的长连接和短连接，实质上是TCP协议的长连接和短连接。

**简而言之：在事务处理结束之后仍然保持打开状态的TCP连接被称为持久连接。非持久连接会在每个事务结束后关闭。**

**持久连接的一个最大的好处是：大大减少了连接的建立和关闭的时延。多个请求响应在一条连接内完成。**

**缺点：请求的响应是顺序执行的。需要等到请求1的响应1收到之后，请求2才会发出。这就是持久连接与管道化连接不同的地方**

### 什么是管道化连接？

管道化连接是需要持久化连接支持的。**管道化连接是在持久连接的基础上，以“流水线”的方式发送请求：不需要等到请求1的响应到达Client，就可以发送请求2....**

### TCP连接

TCP/IP是全球你计算机及其网络设备都在使用的一种常用的分组交换网络协议集。
Http要传送一条报文时，会以流的形式将报文数据的内容通过一条已打开的TCP连接按序传输。TCP收到数据流之后，会将数据流砍成被称作段的小数据块，并将其封装在IP分组中，通过因特网进行传输。

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fuh13lkw4aj30sg080dgi.jpg)

网络通信时采用TCP协议时，在真正的读写操作之前，server与client之间必须建立一个连接，当读写操作完成后，双方不再需要这个连接时它们可以释放这个连接，连接的建立是需要3次握手的，而释放则需要4次握手，所以说每个连接的建立都是需要资源消耗和时间消耗的。

三次握手示意图：
![](https://ws3.sinaimg.cn/large/006tNbRwgy1fuhql67ui4j30ld0cutbv.jpg)

四次握手关闭图：
![](https://ws4.sinaimg.cn/large/006tNbRwgy1fuhqlnt8ijj30os0ffwtl.jpg)

TCP在其协议头中使用大量的标志位或者说1位（bit）布尔域来控制连接状态，我们最感兴趣的3个标志位如下：

- **SYN** - 创建一个连接
- **FIN** - 终结一个连接
- **ACK** - 确认收到数据

一个包中可以有多个标志位。

TCP/IP的可靠性：
- 无差错的数据传输
- 按序传输（数据总是会按照发送的顺序到达）
- 未分段的数据流（可以在任意时刻以任意尺寸将数据发送出去）

只要建立了TCP连接，客户端和服务器之间的报文交换就不会丢失、不会被破坏，也不会在接受时出现错序了。

### 三次握手

**第一次握手**：客户端发送SYN包至服务器，并进入SYN_SENT状态，等待服务器确认。

**第二次握手**：服务器收到客户端的SYN包，发送一个ACK，同时发送自己的SYN，此时服务器进入SYN_RCVD状态。

**第三次握手**：客户端接收到服务器发送的SYN+ACK后，进入ESTABLISHED状态，并发送服务器SYN包的确认ACK，服务器接收到客户端ACK后，进入ESTABLISHED状态。

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fuhpljw6s1j30cv06caa9.jpg)

### 四次挥手

**第一次挥手**：主动关闭方发送一个FIN并进入FIN_WAIT1状态。

**第二次挥手**：被动关闭方接收到主动关闭方发送的FIN并发送ACK，此时被动关闭方进入CLOSE_WAIT状态；主动关闭方收到被动关闭方的ACK后，进入FIN_WAIT2状态。

**第三次挥手**：被动关闭方发送一个FIN并进入LAST_ACK状态。

**第四次挥手**：主动关闭方收到被动关闭方发送的FIN并发送ACK，此时主动关闭方进入TIME_WAIT状态，经过2MSL**(Maximum Segment Lifetime - 报文最大生存时间)**时间后关闭连接；被动关闭方收到主动关闭方的ACK后，关闭连接。

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fuhq1h4e8pj30cu0530sv.jpg)
